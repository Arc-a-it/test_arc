name: ArcVision Impact Guard

on:
  pull_request:
    branches: [ main, master, develop ]
    types: [ opened, synchronize, reopened ]

jobs:
  impact-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install ArcVision CLI
      run: |
        npm install -g arcvision

    - name: Check for bypass token in PR description
      id: bypass_check
      run: |
        # Extract bypass token from PR description if present
        PR_BODY=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" \
          | jq -r '.body')
        
        BYPASS_TOKEN=""
        if echo "$PR_BODY" | grep -q "BYPASS_TOKEN:"; then
          BYPASS_TOKEN=$(echo "$PR_BODY" | grep "BYPASS_TOKEN:" | cut -d: -f2 | tr -d ' ')
        fi
        
        echo "bypass_token=$BYPASS_TOKEN" >> $GITHUB_OUTPUT

    - name: Generate current context
      run: |
        arcvision scan --output current-context.json

    - name: Get base branch context
      run: |
        git checkout ${{ github.event.pull_request.base.sha }}
        arcvision scan --output base-context.json
        git checkout ${{ github.event.pull_request.head.sha }}

    - name: Compare contexts and analyze impact
      id: impact
      run: |
        # Generate diff analysis
        arcvision diff base-context.json current-context.json --output impact-report.json
        
        # Check for critical violations using the new ACIG
        if [ -f ".arcvision/invariants.json" ]; then
          echo "Running authoritative change impact evaluation..."
          RESULT=$(arcvision evaluate --context-file impact-report.json --invariants-file .arcvision/invariants.json --verbose 2>&1)
          EXIT_CODE=$?
          
          # Parse the ACIG output
          if echo "$RESULT" | grep -q "BLOCKED"; then
            echo "has_critical=true" >> $GITHUB_OUTPUT
            echo "has_warnings=false" >> $GITHUB_OUTPUT
            echo "critical_count=1" >> $GITHUB_OUTPUT
            echo "warning_count=0" >> $GITHUB_OUTPUT
            echo "Change BLOCKED by Authoritative Change Impact Gate" > critical-issues.txt
            echo "Blocking evaluation due to critical violations:" > evaluation-output.txt
            echo "$RESULT" >> evaluation-output.txt
          elif echo "$RESULT" | grep -q "RISKY"; then
            echo "has_critical=false" >> $GITHUB_OUTPUT
            echo "has_warnings=true" >> $GITHUB_OUTPUT
            echo "critical_count=0" >> $GITHUB_OUTPUT
            echo "warning_count=1" >> $GITHUB_OUTPUT
            echo "Change flagged as RISKY by Authoritative Change Impact Gate" > warning-issues.txt
            echo "Risky evaluation output:" > evaluation-output.txt
            echo "$RESULT" >> evaluation-output.txt
          else
            echo "has_critical=false" >> $GITHUB_OUTPUT
            echo "has_warnings=false" >> $GITHUB_OUTPUT
            echo "critical_count=0" >> $GITHUB_OUTPUT
            echo "warning_count=0" >> $GITHUB_OUTPUT
            echo "No critical issues found by Authoritative Change Impact Gate" > evaluation-output.txt
          fi
        else
          # Fallback to basic checks if no invariants file
          echo "No invariants file found, running basic checks..."
          node << 'EOF'
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('impact-report.json', 'utf8'));
          
          const criticalIssues = [];
          const warnings = [];
          
          // Check blast radius increases
          if (report.blast_radius_changes) {
            report.blast_radius_changes.forEach(change => {
              if (change.percentage_increase > 50) {
                criticalIssues.push(`High blast radius increase: ${change.file} (+${change.percentage_increase}%)`);
              } else if (change.percentage_increase > 20) {
                warnings.push(`Moderate blast radius increase: ${change.file} (+${change.percentage_increase}%)`);
              }
            });
          }
          
          // Check invariant violations
          if (report.invariant_violations && report.invariant_violations.length > 0) {
            report.invariant_violations.forEach(violation => {
              if (violation.severity === 'critical') {
                criticalIssues.push(`Invariant violation: ${violation.description}`);
              } else {
                warnings.push(`Invariant warning: ${violation.description}`);
              }
            });
          }
          
          // Check authority core changes
          if (report.authority_core_changes && report.authority_core_changes.length > 0) {
            report.authority_core_changes.forEach(change => {
              criticalIssues.push(`Authority core modified: ${change.file} - ${change.reason}`);
            });
          }
          
          const hasCritical = criticalIssues.length > 0;
          const hasWarnings = warnings.length > 0;
          
          console.log('::set-output name=has_critical::' + hasCritical);
          console.log('::set-output name=has_warnings::' + hasWarnings);
          console.log('::set-output name=critical_count::' + criticalIssues.length);
          console.log('::set-output name=warning_count::' + warnings.length);
          
          fs.writeFileSync('critical-issues.txt', criticalIssues.join('\n'));
          fs.writeFileSync('warning-issues.txt', warnings.join('\n'));
          
          console.log('Critical Issues:');
          criticalIssues.forEach(issue => console.log('âŒ ' + issue));
          console.log('Warnings:');
          warnings.forEach(warning => console.log('âš ï¸ ' + warning));
          EOF
        fi

    - name: Comment on PR with analysis and bypass instructions
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let comment = `## ðŸ›¡ï¸ ArcVision Impact Guard Analysis\n\n`;
          
          const criticalCount = '${{ steps.impact.outputs.critical_count }}';
          const warningCount = '${{ steps.impact.outputs.warning_count }}';
          const bypassToken = '${{ steps.bypass_check.outputs.bypass_token }}';
          
          if (criticalCount > 0) {
            comment += `### âŒ Critical Issues Found (${criticalCount})\n`;
            try {
              const criticalIssues = fs.readFileSync('critical-issues.txt', 'utf8').split('\n').filter(Boolean);
              criticalIssues.forEach(issue => {
                comment += `- ${issue}\n`;
              });
            } catch (e) {
              // If no specific critical issues file, use generic message
              comment += `- Change blocked by Authoritative Change Impact Gate\n`;
            }
            comment += '\n';
          }
          
          if (warningCount > 0) {
            comment += `### âš ï¸ Warnings (${warningCount})\n`;
            try {
              const warningIssues = fs.readFileSync('warning-issues.txt', 'utf8').split('\n').filter(Boolean);
              warningIssues.forEach(warning => {
                comment += `- ${warning}\n`;
              });
            } catch (e) {
              // If no specific warning issues file, use generic message
              comment += `- Change flagged as risky by Authoritative Change Impact Gate\n`;
            }
            comment += '\n';
          }
          
          if (criticalCount == 0 && warningCount == 0) {
            comment += 'âœ… No critical issues or warnings detected. Change appears safe.\n\n';
          } else if (criticalCount == 0) {
            comment += 'âš ï¸ No critical issues, but please review warnings before merging.\n\n';
          }
          
          // Add bypass instructions if there are critical issues
          if (criticalCount > 0) {
            comment += `### ðŸš¨ Bypass Instructions\n\n`;
            comment += `If you absolutely need to proceed with these critical changes:\n\n`;
            comment += `1. **Generate a bypass token locally:**\n`;
            comment += '   ```bash\n';
            comment += '   arcvision-guard bypass-request --reason "Brief explanation of why this change is necessary"\n';
            comment += '   ```\n\n';
            comment += `2. **Add the token to your PR description:**\n`;
            comment += `   Add this line to your PR description:\n`;
            comment += `   \`\`\`\n`;
            comment += `   BYPASS_TOKEN: your_generated_token_here\n`;
            comment += `   \`\`\`\n\n`;
            comment += `3. **Push your changes again**\n\n`;
            comment += `âš ï¸ **WARNING:** Bypass tokens are for emergency situations only. `;
            comment += `They expire in 24 hours and can only be used once.\n\n`;
          }
          
          // Add evaluation output if available
          try {
            const evalOutput = fs.readFileSync('evaluation-output.txt', 'utf8');
            if (evalOutput && evalOutput.trim()) {
              comment += `### ðŸ“‹ Evaluation Details\n\n`;
              comment += '```\n';
              comment += evalOutput.substring(0, 3000) + '\n'; // Limit output length
              comment += '```\n\n';
            }
          } catch (e) {
            // No evaluation output file, skip
          }
          
          comment += '*Analysis performed by ArcVision Impact Guard*';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Block merge on critical violations (without valid bypass)
      if: steps.impact.outputs.has_critical == 'true' && steps.bypass_check.outputs.bypass_token == ''
      run: |
        echo "::error::ArcVision Impact Guard detected critical violations that must be addressed before merging"
        echo "::error::To bypass, generate a token with 'arcvision-guard bypass-request' and add it to your PR description"
        exit 1

    - name: Allow merge with valid bypass token
      if: steps.impact.outputs.has_critical == 'true' && steps.bypass_check.outputs.bypass_token != ''
      run: |
        echo "::warning::Proceeding with bypass token - critical violations detected but bypass authorized"
        echo "BYPASS_TOKEN_USED=true" >> $GITHUB_ENV
