name: ArcVision Independent Architectural Override

on:
  workflow_dispatch:
  # This allows you to trigger the override manually with hardcoded values

jobs:
  arcvision-override-analysis:
    runs-on: ubuntu-latest
    name: Independent Architectural Override
    
    # Permission to push changes back to the repository
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install ArcVision CLI
        run: |
          echo "Installing ArcVision CLI..."
          npm install -g arcvision
          echo "âœ… ArcVision CLI installed"
          arcvision --version

      - name: Execute Hardcoded Override
        run: |
          # -----------------------------------------------------------------
          # ðŸš€ HARDCODED VALUES - EDIT THESE BEFORE RUNNING
          # -----------------------------------------------------------------
          EVENT_ID="evt_1769399887949_689qgi3f6"
          REASON="Overriding architectural risk/block for critical deployment"
          OWNER="github-actions-test@arcvision.ai"
          COMMIT_HASH="HEAD"
          # -----------------------------------------------------------------
          
          echo "ðŸ›¡ï¸  Overriding decision for Event ID: $EVENT_ID"
          echo "Reason: $REASON"
          echo "Owner: $OWNER"
          echo "Commit: $COMMIT_HASH"
          echo ""
          
          # Validate hardcoded values
          if [ -z "$EVENT_ID" ] || [ "$EVENT_ID" = "evt_replace_me" ]; then
            echo "âŒ EVENT_ID must be set to a valid blocked event ID"
            exit 1
          fi
          
          if [ ${#REASON} -lt 10 ]; then
            echo "âŒ REASON must be at least 10 characters long"
            exit 1
          fi
          
          if [ -z "$OWNER" ] || [ "$OWNER" = "admin@arcvision.ai" ]; then
            echo "âŒ OWNER must be set to actual responsible person"
            exit 1
          fi
          
          echo "âœ… Hardcoded values validation passed"
          echo ""
          
          # Execute the override
          arcvision override \
            --event-id "$EVENT_ID" \
            --reason "$REASON" \
            --owner "$OWNER" \
            --commit "$COMMIT_HASH"

      - name: Verify Override Success
        run: |
          echo "ðŸ” Verifying override was recorded..."
          if [ -f "arcvision_context/architecture.authority.ledger.json" ]; then
            echo "âœ… Authority ledger found"
            # Show recent ledger entries
            tail -20 arcvision_context/architecture.authority.ledger.json || echo "Cannot display ledger"
          else
            echo "âŒ Authority ledger not found"
            exit 1
          fi
          
          # Check if the override event exists
          if grep -q "$EVENT_ID" arcvision_context/architecture.authority.ledger.json; then
            echo "âœ… Override event recorded in ledger"
          else
            echo "âš ï¸  Override event not found in ledger"
          fi

      - name: Push Ledger Changes to GitHub
        run: |
          echo "ðŸ“ Syncing Authority Ledger to GitHub..."
          git config --global user.name "ArcVision Governance Bot"
          git config --global user.email "governance@arcvision.ai"
          
          # Add the ledger file specifically
          git add arcvision_context/architecture.authority.ledger.json
          
          # Only commit if something changed
          if ! git diff --staged --quiet; then
            git commit -m "chore(governance): recorded override for $EVENT_ID"
            git push origin HEAD:${{ github.ref }}
            echo "âœ… Override successfully synced to GitHub ledger."
          else
            echo "âš ï¸  No changes to ledger detected. Override may have failed."
            exit 1
          fi

      - name: Generate Override Report
        run: |
          echo "ðŸ“ Generating override execution report..."
          cat > arcvision-override-report.md << EOF
          # ArcVision Override Execution Report
          
          ## Override Details
          - **Event ID**: $EVENT_ID
          - **Reason**: $REASON
          - **Owner**: $OWNER
          - **Commit**: $COMMIT_HASH
          - **Execution Time**: $(date)
          - **Repository**: ${{ github.repository }}
          - **Branch**: ${{ github.ref }}
          
          ## Status
          âœ… Override executed successfully and committed to ledger
          
          ## Next Steps
          1. Monitor for any related architectural impacts
          2. Document this override in team knowledge base
          3. Review override frequency for governance improvement
          
          *Generated by ArcVision Hardcoded Override Workflow*
          EOF
          echo "âœ… Override report generated"

      - name: Upload Override Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: arcvision-override-execution
          path: |
            arcvision_context/architecture.authority.ledger.json
            arcvision-override-report.md
          retention-days: 30

      - name: Summary
        run: |
          echo "ðŸŽ‰ ArcVision Override Execution Complete!"
          echo ""
          echo "ðŸ“‹ Summary:"
          echo "   â€¢ Event ID: $EVENT_ID"
          echo "   â€¢ Reason: $REASON"
          echo "   â€¢ Owner: $OWNER"
          echo "   â€¢ Commit: $COMMIT_HASH"
          echo "   â€¢ Status: âœ… Successfully overridden and recorded"
          echo ""
          echo "ðŸ“ Artifacts available:"
          echo "   â€¢ Updated authority ledger"
          echo "   â€¢ Execution report"
          echo ""
          echo "âœ… Override workflow execution successful"
